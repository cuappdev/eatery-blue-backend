generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum CampusArea {
  EAST
  WEST
  NORTH
  CENTRAL
  COLLEGETOWN
  SOUTH
  NONE
}

enum PaymentMethod {
  MEAL_SWIPE
  CASH
  CARD
  BRB
  FREE
}

enum EateryType {
  DINING_ROOM
  CAFE
  COFFEE_SHOP
  FOOD_COURT
  CONVENIENCE_STORE
  CART
  GENERAL
}

enum EventType {
  AVAILABLE_ALL_DAY
  BREAKFAST
  BRUNCH
  DINNER
  EMPTY
  LATE_LUNCH
  LUNCH
  OPEN
  GENERAL // Used for dummy event for Cafe eateries (ones with no menus)
  PANTS // Pants
}

model User {
  id           Int    @id @default(autoincrement())
  deviceUuid   String @unique
  refreshToken String @unique

  fcmTokens          FCMToken[]
  reports            Report[]
  favoritedEateries  FavoritedEatery[]
  favoritedItemNames String[]
  userEventVotes     UserEventVote[]

  @@index(favoritedItemNames, type: Gin) // The performance magic
}

model FavoritedEatery {
  user     User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId   Int
  eatery   Eatery @relation(fields: [eateryId], references: [id])
  eateryId Int

  @@id([userId, eateryId])
}

model FCMToken {
  id        Int      @id @default(autoincrement())
  token     String   @unique
  createdAt DateTime @default(now())

  user   User @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId Int

  @@index([userId])
}

model Report {
  id        Int      @id @default(autoincrement())
  netid     String?
  content   String
  createdAt DateTime @default(now())

  user     User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId   Int
  eatery   Eatery? @relation(fields: [eateryId], references: [id], onDelete: SetNull)
  eateryId Int?

  @@index([eateryId])
  @@index([userId])
}

model Eatery {
  id             Int             @id @default(autoincrement())
  cornellId      Int?            @unique
  announcements  String[]
  name           String
  shortName      String
  about          String
  shortAbout     String
  cornellDining  Boolean
  menuSummary    String
  imageUrl       String
  campusArea     CampusArea
  onlineOrderUrl String?
  contactPhone   String?
  contactEmail   String?
  latitude       Float
  longitude      Float
  location       String
  paymentMethods PaymentMethod[]
  eateryTypes    EateryType[]
  createdAt      DateTime        @default(now())

  events            Event[]
  favoritedEateries FavoritedEatery[]
  reports           Report[]
}

model Event {
  id             Int       @id @default(autoincrement())
  type           EventType
  startTimestamp DateTime
  endTimestamp   DateTime
  upvotes        Int       @default(0)
  downvotes      Int       @default(0)
  createdAt      DateTime  @default(now())

  eatery   Eatery @relation(fields: [eateryId], references: [id], onDelete: Cascade)
  eateryId Int

  menu           Category[]
  userEventVotes UserEventVote[]

  @@index([eateryId, startTimestamp, endTimestamp])
}

model UserEventVote {
  upvoted Boolean

  user    User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId  Int
  event   Event @relation(fields: [eventId], references: [id], onDelete: Cascade)
  eventId Int

  @@id([userId, eventId])
  @@index([eventId])
}

model Category {
  id        Int      @id @default(autoincrement())
  name      String
  createdAt DateTime @default(now())

  event   Event  @relation(fields: [eventId], references: [id], onDelete: Cascade)
  eventId Int
  items   Item[]

  @@index([eventId])
}

model Item {
  id        Int      @id @default(autoincrement())
  name      String
  basePrice Decimal?
  createdAt DateTime @default(now())

  category           Category            @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  categoryId         Int
  dietaryPreferences DietaryPreference[]
  allergens          Allergen[]

  @@index([categoryId])
  @@index([name])
}

model DietaryPreference {
  name  String @id @unique
  items Item[]
}

model Allergen {
  name  String @id @unique
  items Item[]
}